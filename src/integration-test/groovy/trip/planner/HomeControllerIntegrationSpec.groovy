package trip.planner

import grails.test.mixin.TestFor
import grails.test.mixin.integration.Integration
import grails.transaction.Rollback
import grails.util.GrailsWebMockUtil
import org.apache.http.HttpStatus
import org.springframework.beans.factory.annotation.Autowired
import org.springframework.web.context.WebApplicationContext
import org.springframework.web.context.request.RequestContextHolder
import spock.lang.Specification

@TestFor(HomeController)
@Integration
@Rollback
class HomeControllerIntegrationSpec extends Specification {

    private static final String LEIPZIG = "Leipzig"
    private static final String LEIPZIG_AUGUSTUSPLATZ = "Augustusplatz Leipzig"
    private static final String TAUCHA = "Taucha"
    private static final String NOT_EXISTING_CITY_1 = "not-existing-15451245"
    private static final String NOT_EXISTING_CITY_2 = "not-existing-10092454"

    @Autowired
    WebApplicationContext ctx

    def setup() {
        GrailsWebMockUtil.bindMockWebRequest(ctx)
    }

    def cleanup() {
        RequestContextHolder.resetRequestAttributes()
    }

    void "test get route returns OK"() {
        when:
        controller.getRoute(LEIPZIG, TAUCHA, 0)
        def response = controller.response

        then:
        response.status == HttpStatus.SC_OK
    }

    void "test get route returns route and poi"() {
        when:
        controller.getRoute(LEIPZIG, TAUCHA, 0)

        def response = controller.response

        then:
        response.content.toString().equals('{"success":true,"route":[["12.380986","51.339086"],["12.380737","51.339156"],["12.380498","51.339243"],["12.380297","51.339313"],["12.380178","51.339390"],["12.380144","51.339429"],["12.380135","51.339479"],["12.380142","51.339544"],["12.380156","51.339590"],["12.380225","51.339759"],["12.380308","51.339975"],["12.380318","51.340054"],["12.380325","51.340107"],["12.380345","51.340233"],["12.380380","51.340360"],["12.380481","51.340626"],["12.380569","51.340859"],["12.380702","51.341223"],["12.380739","51.341323"],["12.381009","51.342043"],["12.381050","51.342145"],["12.381248","51.342695"],["12.381320","51.342830"],["12.381418","51.343092"],["12.381455","51.343167"],["12.381492","51.343212"],["12.381554","51.343264"],["12.381639","51.343300"],["12.381815","51.343333"],["12.382013","51.343310"],["12.382185","51.343280"],["12.382515","51.343207"],["12.382609","51.343176"],["12.382685","51.343145"],["12.382758","51.343116"],["12.382861","51.343085"],["12.382969","51.343055"],["12.383051","51.343034"],["12.383094","51.343025"],["12.383110","51.343024"],["12.383191","51.343028"],["12.383301","51.343058"],["12.383378","51.343098"],["12.383458","51.343202"],["12.383475","51.343263"],["12.383484","51.343295"],["12.383488","51.343314"],["12.383492","51.343335"],["12.383501","51.343385"],["12.383513","51.343439"],["12.383528","51.343487"],["12.383627","51.343738"],["12.383668","51.343792"],["12.383789","51.343872"],["12.384457","51.344105"],["12.384771","51.344220"],["12.384991","51.344324"],["12.385213","51.344463"],["12.385738","51.344952"],["12.385936","51.345128"],["12.386089","51.345241"],["12.386219","51.345325"],["12.386383","51.345415"],["12.386624","51.345519"],["12.386692","51.345544"],["12.386835","51.345596"],["12.386930","51.345629"],["12.386984","51.345650"],["12.387124","51.345701"],["12.387171","51.345718"],["12.387868","51.345967"],["12.388121","51.346080"],["12.388146","51.346098"],["12.388355","51.346254"],["12.388478","51.346332"],["12.388601","51.346386"],["12.388797","51.346436"],["12.388996","51.346456"],["12.389990","51.346457"],["12.390820","51.346440"],["12.391339","51.346379"],["12.391660","51.346336"],["12.391858","51.346312"],["12.391974","51.346301"],["12.392161","51.346283"],["12.392386","51.346264"],["12.392668","51.346249"],["12.392990","51.346223"],["12.393339","51.346209"],["12.393395","51.346204"],["12.393948","51.346153"],["12.394028","51.346147"],["12.394276","51.346147"],["12.394417","51.346143"],["12.394500","51.346138"],["12.394570","51.346135"],["12.394752","51.346124"],["12.394909","51.346116"],["12.395727","51.346076"],["12.396740","51.346024"],["12.397447","51.345990"],["12.398332","51.345943"],["12.398737","51.345922"],["12.399152","51.345899"],["12.399669","51.345869"],["12.399826","51.345861"],["12.400376","51.345831"],["12.401915","51.345743"],["12.403102","51.345682"],["12.403336","51.345668"],["12.404537","51.345603"],["12.405940","51.345527"],["12.406029","51.345522"],["12.407332","51.345454"],["12.408961","51.345359"],["12.409154","51.345348"],["12.409319","51.345337"],["12.410971","51.345266"],["12.413005","51.345157"],["12.413390","51.345135"],["12.413967","51.345099"],["12.414129","51.345089"],["12.414252","51.345081"],["12.414374","51.345072"],["12.414406","51.345072"],["12.414689","51.345183"],["12.414824","51.345263"],["12.415525","51.345684"],["12.415948","51.345970"],["12.416518","51.346298"],["12.417136","51.346676"],["12.417825","51.347059"],["12.418137","51.347249"],["12.418375","51.347390"],["12.419423","51.348010"],["12.419518","51.348067"],["12.419900","51.348286"],["12.420608","51.348699"],["12.420978","51.348916"],["12.421230","51.349069"],["12.421426","51.349185"],["12.421560","51.349263"],["12.423265","51.350267"],["12.423309","51.350291"],["12.423468","51.350393"],["12.423565","51.350451"],["12.423744","51.350542"],["12.424896","51.351087"],["12.426089","51.351651"],["12.426253","51.351727"],["12.426370","51.351783"],["12.426518","51.351857"],["12.426562","51.351876"],["12.426715","51.351946"],["12.426923","51.352040"],["12.431091","51.354033"],["12.431555","51.354255"],["12.433483","51.355180"],["12.434260","51.355563"],["12.435266","51.356059"],["12.436916","51.356847"],["12.437857","51.357294"],["12.438970","51.357825"],["12.441583","51.359076"],["12.442133","51.359297"],["12.442317","51.359368"],["12.443049","51.359592"],["12.443509","51.359801"],["12.443562","51.359825"],["12.443780","51.359923"],["12.443919","51.360001"],["12.444116","51.360096"],["12.444772","51.360408"],["12.445070","51.360600"],["12.446027","51.361038"],["12.446274","51.361151"],["12.447746","51.361818"],["12.448542","51.362199"],["12.451275","51.363514"],["12.451518","51.363631"],["12.452716","51.364211"],["12.452964","51.364331"],["12.453471","51.364540"],["12.454046","51.364765"],["12.455393","51.365255"],["12.455651","51.365349"],["12.455755","51.365379"],["12.456742","51.365720"],["12.460542","51.367113"],["12.460635","51.367146"],["12.460861","51.367228"],["12.460934","51.367254"],["12.460951","51.367261"],["12.460985","51.367273"],["12.460998","51.367278"],["12.461082","51.367308"],["12.461306","51.367389"],["12.463461","51.368152"],["12.465619","51.368940"],["12.466099","51.369133"],["12.466325","51.369205"],["12.466423","51.369240"],["12.466834","51.369391"],["12.467480","51.369623"],["12.467901","51.369770"],["12.468544","51.370011"],["12.469530","51.370375"],["12.469795","51.370474"],["12.470204","51.370623"],["12.470378","51.370682"],["12.470569","51.370749"],["12.470667","51.370786"],["12.471114","51.370938"],["12.471971","51.371259"],["12.472444","51.371437"],["12.472755","51.371560"],["12.473166","51.371724"],["12.473825","51.371981"],["12.473996","51.372085"],["12.474081","51.372112"],["12.475585","51.372687"],["12.475777","51.372754"],["12.476915","51.373168"],["12.477543","51.373399"],["12.478061","51.373586"],["12.478354","51.373698"],["12.479365","51.374048"],["12.479475","51.374089"],["12.480621","51.374494"],["12.481646","51.374861"],["12.481748","51.374893"],["12.482392","51.375133"],["12.482692","51.375258"],["12.484717","51.375997"],["12.485992","51.376442"],["12.486387","51.376582"],["12.486617","51.376665"],["12.486830","51.376742"],["12.487683","51.377053"],["12.487841","51.377113"],["12.487952","51.377152"],["12.488777","51.377463"],["12.488952","51.377546"],["12.489134","51.377646"],["12.489461","51.377847"],["12.490014","51.378189"],["12.490411","51.378422"],["12.490567","51.378523"],["12.491536","51.379119"],["12.491605","51.379164"],["12.492209","51.379525"],["12.492336","51.379584"],["12.492462","51.379629"],["12.492754","51.379724"],["12.493055","51.379809"],["12.493325","51.379878"],["12.493587","51.379940"],["12.493655","51.379958"]],"pois":[{"clusterCenter":{"lat":51.3692482,"lon":12.4356056},"points":[{"lat":51.3692482,"lon":12.4356056}]}],"startCoordinates":[51.3391827,12.3810549]}')
    }

    void "test get route with not existing start place"() {
        when:
        controller.getRoute(NOT_EXISTING_CITY_1, LEIPZIG, 0)

        def response = controller.response

        then:
        response.content.toString().equals('{"success":false,"error":"Error: Unable to find \'' + NOT_EXISTING_CITY_1
                + '\'!"}')
    }

    void "test get route with not existing destination place"() {
        when:
        controller.getRoute(LEIPZIG, NOT_EXISTING_CITY_1, 0)

        def response = controller.response

        then:
        response.content.toString().equals('{"success":false,"error":"Error: Unable to find \'' + NOT_EXISTING_CITY_1
                + '\'!"}')
    }

    void "test get route with not existing start and destination place"() {
        when:
        controller.getRoute(NOT_EXISTING_CITY_1, NOT_EXISTING_CITY_2, 0)

        def response = controller.response

        then:
        response.content.toString().equals('{"success":false,"error":"Error: Unable to find \'' + NOT_EXISTING_CITY_1
                + '\' and \'' + NOT_EXISTING_CITY_2 + '\'!"}')
    }

    void "test get route with equal start and destination place"() {
        when:
        controller.getRoute(LEIPZIG, LEIPZIG, 0)

        def response = controller.response

        then:
        response.content.toString().equals('{"success":false,"error":"Error: Unable to generate route, given places are equal."}')
    }
}
